import streamlit as st
import pandas as pd 
import numpy as np 
import matplotlib.pyplot as plt 
import seaborn as sns 
import os
from mpl_toolkits.mplot3d import Axes3D # 3D ê·¸ë˜í”„ìš©

# í•œê¸€ í°íŠ¸ ì„¤ì •
if os.name == 'nt': 
    plt.rc('font', family='Malgun Gothic') 
    plt.rc('axes', unicode_minus=False)

st.title("ğŸ“Š êµ­ì„¸ì²­ ê·¼ë¡œì†Œë“ ë°ì´í„° ë¶„ì„ê¸°")

# ë°ì´í„° ê²½ë¡œ (í•„ìš”ì‹œ ìˆ˜ì •)
file_path = "êµ­ì„¸ì²­_ê·¼ë¡œì†Œë“ ë°±ë¶„ìœ„(ì²œë¶„ìœ„) ìë£Œ_20241231.csv"

try:
    # ---------------------------------------------------------
    # 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ì „ì²˜ë¦¬
    # ---------------------------------------------------------
    file_name = "í•œêµ­ë†ìˆ˜ì‚°ì‹í’ˆìœ í†µê³µì‚¬_êµ­ê°€ë³„ ì—°ë„ë³„ ìˆ˜ì¶œì‹¤ì _20241231.csv"
    
    # í•œê¸€ ë°ì´í„°ëŠ” ì¸ì½”ë”©ì´ ì¤‘ìš”í•©ë‹ˆë‹¤. (utf-8ì´ ì•ˆ ë˜ë©´ cp949ë¡œ ì‹œë„)
    try:
        df_raw = pd.read_csv(file_name)
    except UnicodeDecodeError:
        df_raw = pd.read_csv(file_name, encoding='cp949')

    # (1) êµ­ê°€ëª… ì •ë¦¬ í•¨ìˆ˜ (' - ì¤‘ êµ­' -> 'ì¤‘êµ­', 'ì¼ ë³¸' -> 'ì¼ë³¸')
    def clean_country_name(name):
        return name.replace(' - ', '').replace(' ', '')

    df_raw['clean_name'] = df_raw['êµ¬ë¶„'].apply(clean_country_name)

    # (2) ì£¼ìš” êµ­ê°€ ìœ„ë„/ê²½ë„ ë§¤í•‘ (ë°ì´í„°ì— ì¢Œí‘œê°€ ì—†ì–´ì„œ ì§ì ‘ ì¶”ê°€í•¨)
    country_coords = {
        'ì¼ë³¸': [36.20, 138.25], 'ì¤‘êµ­': [35.86, 104.19], 'í™ì½©': [22.31, 114.16],
        'ëŒ€ë§Œ': [23.69, 120.96], 'ë¯¸êµ­': [37.09, -95.71], 'ìºë‚˜ë‹¤': [56.13, -106.34],
        'ë² íŠ¸ë‚¨': [14.05, 108.27], 'íƒœêµ­': [15.87, 100.99], 'ì¸ë„ë„¤ì‹œì•„': [-0.78, 113.92],
        'í•„ë¦¬í•€': [12.87, 121.77], 'ë§ë ˆì´ì‹œì•„': [4.21, 101.97], 'ë„¤ëœë€ë“œ': [52.13, 5.29],
        'ì˜êµ­': [55.37, -3.43], 'ë…ì¼': [51.16, 10.45], 'í”„ë‘ìŠ¤': [46.22, 2.21],
        'ëŸ¬ì‹œì•„': [61.52, 105.31], 'ëª½ê³¨': [46.86, 103.84], 'ì¹´ìíìŠ¤íƒ„': [48.01, 66.92],
        'ë©•ì‹œì½”': [23.63, -102.55], 'ë¸Œë¼ì§ˆ': [-14.23, -51.92], 'ê³¼í…Œë§ë¼': [15.78, -90.23], 'ì½°í…Œë§ë¼': [15.78, -90.23],
        'íŒŒë‚˜ë§ˆ': [8.53, -80.78], 'UAE': [23.42, 53.84], 'ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„': [23.88, 45.07],
        'ì¹´íƒ€ë¥´': [25.35, 51.18], 'ì¿ ì›¨ì´íŠ¸': [29.31, 47.48], 'í˜¸ì£¼': [-25.27, 133.77],
        'ë‰´ì§ˆëœë“œ': [-40.90, 174.88], 'ë‚˜ì´ì§€ë¦¬ì•„': [9.08, 8.67], 'ì½”íŠ¸ë””ë¶€ì•„ë¥´': [7.54, -5.54],
        'ê°€ë‚˜': [7.94, -1.02]
    }

    # (3) ì§€ë„ì— ê·¸ë¦´ ë°ì´í„°ë§Œ ë½‘ì•„ë‚´ê¸°
    map_data = []
    for index, row in df_raw.iterrows():
        name = row['clean_name']
        if name in country_coords:
            lat, lon = country_coords[name]
            # '24ë…„ìˆ˜ì¶œê¸ˆì•¡'ì„ ë†’ì´ë¡œ ì‚¬ìš© (ìˆ«ìê°€ ë„ˆë¬´ í¬ë©´ ì ë‹¹íˆ ë‚˜ëˆ”)
            value = row['24ë…„ìˆ˜ì¶œê¸ˆì•¡'] 
            map_data.append({
                'êµ­ê°€ëª…': name,
                'lat': lat,
                'lon': lon,
                'ìˆ˜ì¶œì•¡': value,
                # ì§€ë„ì— í‘œì‹œí•  í…ìŠ¤íŠ¸ìš© (ì–µ ë‹¨ìœ„ ë³€í™˜ ë“±)
                'ìˆ˜ì¶œì•¡_í‘œì‹œ': f"{value:,.0f}" 
            })
    
    df_map = pd.DataFrame(map_data)
    
    st.success(f"ğŸ“‚ '{file_name}' íŒŒì¼ ë¡œë“œ ì„±ê³µ! (ì´ {len(df_map)}ê°œ êµ­ê°€ ë§¤í•‘ë¨)")
    
    with st.expander("ê°€ê³µëœ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°"):
        st.dataframe(df_map)

    # ---------------------------------------------------------
    # 2. PyDeckìœ¼ë¡œ 3D ì§€ë„ ê·¸ë¦¬ê¸° (íŒŒë€ìƒ‰ ìŠ¤íƒ€ì¼)
    # ---------------------------------------------------------
    import pydeck as pdk

    st.subheader("ğŸŒ 2024ë…„ ë†ìˆ˜ì‚°ì‹í’ˆ êµ­ê°€ë³„ ìˆ˜ì¶œ ì‹¤ì  (3D ì§€ë„)")

    # (1) 3D ë§‰ëŒ€(Column) ë ˆì´ì–´
    layer = pdk.Layer(
        "ColumnLayer",
        data=df_map,
        get_position='[lon, lat]',
        get_elevation='ìˆ˜ì¶œì•¡',
        elevation_scale=0.05,      # â˜…ì¤‘ìš”: ìˆ˜ì¶œì•¡ ìˆ«ìê°€ ì›Œë‚™ ì»¤ì„œ ë°°ìœ¨ì„ ë§ì´ ë‚®ì·„ìŠµë‹ˆë‹¤.
        radius=200000,             # ê¸°ë‘¥ ë‘ê»˜ (200km)
        get_fill_color='[30, 136, 229, 200]', # íŒŒë€ìƒ‰
        pickable=True,
        extruded=True
    )

    # (2) ì´ˆê¸° ì¹´ë©”ë¼ ìœ„ì¹˜ (í•œêµ­ ì¤‘ì‹¬)
    view_state = pdk.ViewState(
        longitude=126.97, 
        latitude=37.56,
        zoom=1.5,
        pitch=45,
    )

    # (3) ì§€ë„ ê·¸ë¦¬ê¸°
    r = pdk.Deck(
        layers=[layer],
        initial_view_state=view_state,
        tooltip={"text": "{êµ­ê°€ëª…}\nìˆ˜ì¶œì•¡: {ìˆ˜ì¶œì•¡_í‘œì‹œ} ë‹¬ëŸ¬"}, # ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ëœ¨ëŠ” ì •ë³´
        map_style=pdk.map_styles.CARTO_LIGHT
    )

    st.pydeck_chart(r)

    # ---------------------------------------------------------
    # 3. ë§ˆë¬´ë¦¬ ì„±ê³µ ì´ë¯¸ì§€
    # ---------------------------------------------------------
    st.write("---") 
    col1, col2, col3 = st.columns([1, 1, 1])
    with col2:
        st.image("smile.png", caption="ë¶„ì„ ì™„ë£Œ! ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤ ğŸ‘", width=200)

except FileNotFoundError:
    st.error(f" âŒ '{file_path}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    
except Exception as e:
    st.error(f" âŒ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")